<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Legal Tool Ultimate</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #222222);
            --hint-color: var(--tg-theme-hint-color, #888);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
            --accent: var(--tg-theme-button-color, #2481cc);
            --green: #34c759; /* iOS Green */
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; display: flex; flex-direction: column; height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- TABS (MENU) --- */
        .tabs {
            display: flex; overflow-x: auto; white-space: nowrap;
            background-color: var(--secondary-bg);
            border-bottom: 1px solid rgba(0,0,0,0.1);
            scrollbar-width: none;
            padding: 0 5px;
            flex-shrink: 0;
        }
        .tabs::-webkit-scrollbar { display: none; }
        
        .tab {
            padding: 14px 16px; text-align: center;
            font-size: 15px; font-weight: 500; color: var(--hint-color);
            border-bottom: 3px solid transparent; flex-shrink: 0;
            cursor: pointer; transition: color 0.2s;
        }
        .tab.active { color: var(--accent); border-bottom: 3px solid var(--accent); }

        /* --- CONTENT AREA --- */
        .content { padding: 20px 16px; flex: 1; overflow-y: auto; display: none; }
        .content.active { display: block; }

        /* --- FORM ELEMENTS --- */
        h2 { margin: 0 0 12px 0; font-size: 19px; font-weight: 700; }
        label { font-size: 13px; color: var(--hint-color); margin-bottom: 6px; display: block; font-weight: 500; }
        
        select, input {
            width: 100%; padding: 12px; border-radius: 12px;
            border: 1px solid var(--hint-color); /* Fallback */
            border: 1px solid rgba(128,128,128, 0.3);
            background-color: var(--secondary-bg);
            color: var(--text-color);
            font-size: 17px; outline: none; margin-bottom: 16px;
            box-sizing: border-box; -webkit-appearance: none;
        }
        input:focus { border-color: var(--accent); }

        .row { display: flex; gap: 12px; }
        .col { flex: 1; }

        /* --- RESULT CARDS --- */
        .result-box {
            background-color: var(--secondary-bg);
            padding: 16px; border-radius: 14px;
            margin-top: 8px; text-align: center; display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .price { font-size: 28px; font-weight: 800; color: var(--accent); margin: 5px 0; }
        .detail-row {
            display: flex; justify-content: space-between;
            font-size: 14px; margin-top: 8px; 
            border-bottom: 1px dashed rgba(128,128,128, 0.3);
            padding-bottom: 4px;
        }

        /* --- TOGGLES (iOS Style) --- */
        .setting-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px; background: var(--secondary-bg);
            padding: 12px 16px; border-radius: 12px;
        }
        .setting-label { font-size: 16px; font-weight: 500; }

        .switch { position: relative; display: inline-block; width: 50px; height: 30px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #e0e0e0; transition: .3s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: "";
            height: 26px; width: 26px;
            left: 2px; bottom: 2px;
            background-color: white; transition: .3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input:checked + .slider { background-color: var(--green); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* --- CURRENCY CARD --- */
        .currency-card {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px; background: var(--secondary-bg);
            border-radius: 12px; margin-bottom: 10px; font-weight: 500;
        }
        .flag { font-size: 20px; margin-right: 10px; }
        .rate-val { font-weight: 800; color: var(--text-color); font-size: 18px;}

        /* --- BUTTON --- */
        .btn-calc {
            width: 100%; padding: 14px; 
            background: var(--accent); color: #fff; 
            border: none; border-radius: 12px; 
            font-size: 16px; font-weight: 600; cursor: pointer;
        }
        .btn-calc:active { opacity: 0.8; }

    </style>
</head>
<body>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('court', this)">üèõ –ó–±—ñ—Ä</div>
        <div class="tab" onclick="switchTab('debt', this)">üìâ –ë–æ—Ä–≥–∏</div>
        <div class="tab" onclick="switchTab('vacation', this)">üèñ –í—ñ–¥–ø—É—Å—Ç–∫–∞</div>
        <div class="tab" onclick="switchTab('curr', this)">üí≤ –í–∞–ª—é—Ç–∞</div>
        <div class="tab" onclick="switchTab('dates', this)">üìÖ –°—Ç—Ä–æ–∫–∏</div>
    </div>

    <div id="tab-court" class="content active">
        <label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è —Å–ø—Ä–∞–≤–∏ (–ü–ú 2026: 3328 –≥—Ä–Ω)</label>
        <select id="claimType" onchange="calcCourt()">
            <option value="money">üí∞ –ú–∞–π–Ω–æ–≤–∏–π (–°—Ç—è–≥–Ω–µ–Ω–Ω—è –±–æ—Ä–≥—É)</option>
            <option value="divorce">üíî –†–æ–∑—ñ—Ä–≤–∞–Ω–Ω—è —à–ª—é–±—É</option>
            <option value="division">üè† –ü–æ–¥—ñ–ª –º–∞–π–Ω–∞ –ø–æ–¥—Ä—É–∂–∂—è</option>
            <option value="non_money">üìÑ –Ü–Ω—à–∏–π –Ω–µ–º–∞–π–Ω–æ–≤–∏–π –ø–æ–∑–æ–≤</option>
            <option value="moral">‚öñÔ∏è –ú–æ—Ä–∞–ª—å–Ω–∞ —à–∫–æ–¥–∞</option>
        </select>
        
        <div id="courtPriceBlock">
            <label>–¶—ñ–Ω–∞ –ø–æ–∑–æ–≤—É (–≥—Ä–Ω)</label>
            <input type="number" id="courtPrice" placeholder="–í–≤–µ–¥—ñ—Ç—å —Å—É–º—É..." inputmode="decimal" oninput="calcCourt()">
        </div>
        
        <div class="result-box" id="resCourt">
            <div>–î–æ —Å–ø–ª–∞—Ç–∏:</div>
            <div class="price" id="courtTotal">0 –≥—Ä–Ω</div>
            <div style="font-size:13px; color:var(--hint-color)" id="courtDesc"></div>
        </div>
    </div>

    <div id="tab-debt" class="content">
        <label>–°—É–º–∞ –∑–∞–±–æ—Ä–≥–æ–≤–∞–Ω–æ—Å—Ç—ñ</label>
        <input type="number" id="debtSum" placeholder="10000" inputmode="decimal" oninput="calcDebt()">
        
        <div class="row">
            <div class="col"><label>–ü–æ—á–∞—Ç–æ–∫</label><input type="date" id="dStart" onchange="calcDebt()"></div>
            <div class="col"><label>–ö—ñ–Ω–µ—Ü—å</label><input type="date" id="dEnd" onchange="calcDebt()"></div>
        </div>

        <div class="setting-row">
            <span class="setting-label">3% —Ä—ñ—á–Ω–∏—Ö (—Å—Ç. 625)</span>
            <label class="switch"><input type="checkbox" id="chk3" checked onchange="calcDebt()"><span class="slider"></span></label>
        </div>

        <div class="setting-row">
            <span class="setting-label">–Ü–Ω—Ñ–ª—è—Ü—ñ–π–Ω—ñ –≤—Ç—Ä–∞—Ç–∏</span>
            <label class="switch"><input type="checkbox" id="chkInf" onchange="calcDebt()"><span class="slider"></span></label>
        </div>
        <input type="number" id="infIdx" placeholder="–°—É–∫—É–ø–Ω–∏–π —ñ–Ω–¥–µ–∫—Å (–Ω–∞–ø—Ä. 110.5)" value="100" style="display:none" inputmode="decimal" oninput="calcDebt()">

        <div class="setting-row">
            <span class="setting-label">–ü–µ–Ω—è</span>
            <label class="switch"><input type="checkbox" id="chkPeny" onchange="toggleInput('penyInput', this)"><span class="slider"></span></label>
        </div>
        <div id="penyInput" style="display:none">
            <label>–°—Ç–∞–≤–∫–∞ –ø–µ–Ω—ñ (% —Ä—ñ—á–Ω–∏—Ö)</label>
            <input type="number" id="penyRate" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥ –ø–æ–¥–≤—ñ–π–Ω–∞ —Å—Ç–∞–≤–∫–∞ –ù–ë–£ (25)" inputmode="decimal" oninput="calcDebt()">
        </div>

        <div class="result-box" id="resDebt" style="text-align: left;">
            <div class="detail-row"><span>–¢—ñ–ª–æ –±–æ—Ä–≥—É:</span> <span id="outBody" style="font-weight:bold">0</span></div>
            <div class="detail-row"><span>3% —Ä—ñ—á–Ω–∏—Ö:</span> <span id="out3">0</span></div>
            <div class="detail-row"><span>–Ü–Ω—Ñ–ª—è—Ü—ñ–π–Ω—ñ:</span> <span id="outInf">0</span></div>
            <div class="detail-row"><span>–ü–µ–Ω—è:</span> <span id="outPeny">0</span></div>
            <div style="text-align:center; margin-top:15px">
                <span style="font-size:12px; color:var(--hint-color)">–†–ê–ó–û–ú –î–û –°–¢–Ø–ì–ù–ï–ù–ù–Ø:</span><br>
                <div class="price" id="debtTotal" style="margin-top:0">0 –≥—Ä–Ω</div>
            </div>
        </div>
    </div>

    <div id="tab-vacation" class="content">
        <label>–î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É –≤—ñ–¥–ø—É—Å—Ç–∫–∏</label>
        <input type="date" id="vacStart" onchange="calcVac()">
        
        <label>–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å (–¥–Ω—ñ–≤)</label>
        <input type="number" id="vacDays" value="14" inputmode="numeric" oninput="calcVac()">

        <div class="setting-row">
            <div>
                <div class="setting-label">–í–æ—î–Ω–Ω–∏–π —Å—Ç–∞–Ω</div>
                <div style="font-size:11px; color:var(--hint-color); margin-top:2px">–°–≤—è—Ç–∞ —î —Ä–æ–±–æ—á–∏–º–∏ –¥–Ω—è–º–∏</div>
            </div>
            <label class="switch">
                <input type="checkbox" id="martialLaw" checked onchange="calcVac()">
                <span class="slider"></span>
            </label>
        </div>

        <div class="result-box" id="resVac" style="display:block; text-align:left">
            <div class="detail-row">
                <span>–û—Å—Ç–∞–Ω–Ω—ñ–π –¥–µ–Ω—å –≤—ñ–¥–ø—É—Å—Ç–∫–∏:</span> 
                <span id="vacLast" style="font-weight:bold">-</span>
            </div>
            <div class="detail-row">
                <span>–ü–µ—Ä—à–∏–π —Ä–æ–±–æ—á–∏–π –¥–µ–Ω—å:</span> 
                <span id="vacReturn" style="font-weight:bold; color:var(--accent)">-</span>
            </div>
        </div>
    </div>

    <div id="tab-curr" class="content">
        <label>–î–∞—Ç–∞ –∫—É—Ä—Å—É (–ù–ë–£)</label>
        <input type="date" id="currDate" onchange="fetchRates()">
        
        <div id="loading" style="text-align:center; display:none; margin: 20px 0; color:var(--hint-color)">‚è≥ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</div>
        <div id="ratesList" style="margin-bottom:20px"></div>

        <label>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤–∞–ª—é—Ç</label>
        <div class="row">
            <div class="col" style="flex:2">
                <input type="number" id="convAmount" placeholder="100" inputmode="decimal" oninput="convert()">
            </div>
            <div class="col" style="flex:1">
                <select id="convCurr" onchange="convert()">
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                </select>
            </div>
        </div>
        <div class="result-box" id="resConv" style="display:block; padding:10px;">
            <div class="price" id="convResult">0.00 UAH</div>
        </div>
    </div>

    <div id="tab-dates" class="content">
        <label>–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –¥–∞—Ç–∏ –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è —Å—Ç—Ä–æ–∫—É</label>
        <div class="row">
            <div class="col"><label>–í—ñ–¥ –¥–∞—Ç–∏</label><input type="date" id="dateCalc1"></div>
            <div class="col"><label>+ –î–Ω—ñ–≤</label><input type="number" id="dateCalcDays" placeholder="10" inputmode="numeric"></div>
        </div>
        <button class="btn-calc" onclick="calcDateSimple()">–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
        
        <div class="result-box" id="resDateSimple">
            <div style="font-size:13px; color:var(--hint-color)">–î–∞—Ç–∞ –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è:</div>
            <div class="price" id="dateSimpleRes">-</div>
        </div>
    </div>

    <script>
        // --- INIT TELEGRAM ---
        let tg = window.Telegram.WebApp;
        tg.ready(); 
        tg.expand();
        const mainButton = tg.MainButton;
        const PM = 3328; // –ü—Ä–æ–∂–∏—Ç–∫–æ–≤–∏–π –º—ñ–Ω—ñ–º—É–º 2026

        // --- TABS LOGIC ---
        function switchTab(id, elem) {
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            elem.classList.add('active');
            
            // –Ø–∫—â–æ –≤—ñ–¥–∫—Ä–∏–ª–∏ –≤–∞–ª—é—Ç—É, –æ–Ω–æ–≤–∏—Ç–∏ –∫—É—Ä—Å
            if(id === 'curr') fetchRates();
        }

        // --- 1. COURT FEE ---
        function calcCourt() {
            let type = document.getElementById("claimType").value;
            let price = parseFloat(document.getElementById("courtPrice").value);
            let fee = 0;
            let desc = "";

            // Show/Hide price input
            let needPrice = !(type === "divorce" || type === "non_money");
            document.getElementById("courtPriceBlock").style.display = needPrice ? "block" : "none";

            // Calculation
            if (type === "money" && price > 0) {
                fee = Math.max(PM*0.4, Math.min(price*0.01, PM*5));
                desc = "1% —Ü—ñ–Ω–∏ (Min 0.4 –ü–ú - Max 5 –ü–ú)";
            } 
            else if (type === "divorce") { fee = PM*0.4; desc = "–§—ñ–∫—Å–æ–≤–∞–Ω–æ 0.4 –ü–ú"; }
            else if (type === "non_money") { fee = PM*0.4; desc = "–§—ñ–∫—Å–æ–≤–∞–Ω–æ 0.4 –ü–ú"; }
            else if (type === "division" && price > 0) {
                fee = Math.max(PM*0.4, Math.min(price*0.01, PM*3));
                desc = "1% —Ü—ñ–Ω–∏ (Max 3 –ü–ú)";
            }
            else if (type === "moral" && price > 0) {
                if (price <= PM*5) fee = PM*0.4; // –Ø–∫ –Ω–µ–º–∞–π–Ω–æ–≤–∏–π, —è–∫—â–æ —Å—É–º–∞ –º–∞–ª–∞
                else fee = Math.max(PM, price*0.015); // 1.5% –∞–ª–µ –Ω–µ –º–µ–Ω—à–µ 1 –ü–ú
                desc = "1.5% —Ü—ñ–Ω–∏ (Min 1 –ü–ú)";
            }

            document.getElementById("courtTotal").innerText = fee.toFixed(2) + " –≥—Ä–Ω";
            document.getElementById("courtDesc").innerText = desc;
            document.getElementById("resCourt").style.display = "block";
            
            sendBtn({type:"court_fee", fee:fee.toFixed(2), desc:type});
        }

        // --- 2. DEBT CALC ---
        function toggleInput(id, cb) {
            document.getElementById(id).style.display = cb.checked ? "block" : "none";
            calcDebt();
        }

        function calcDebt() {
            let s = parseFloat(document.getElementById("debtSum").value);
            let d1 = new Date(document.getElementById("dStart").value);
            let d2 = new Date(document.getElementById("dEnd").value);
            
            // Show inflation input if checked
            document.getElementById("infIdx").style.display = document.getElementById("chkInf").checked ? "block" : "none";

            if(!s || isNaN(d1) || isNaN(d2)) return;
            
            let timeDiff = d2.getTime() - d1.getTime();
            let days = Math.ceil(timeDiff / (1000 * 3600 * 24));
            if(days < 0) days = 0;

            // 3% Annual
            let p3 = document.getElementById("chk3").checked ? s * 0.03 * (days/365) : 0;
            
            // Inflation
            let idx = parseFloat(document.getElementById("infIdx").value);
            let inf = (document.getElementById("chkInf").checked && idx > 100) ? s*(idx/100)-s : 0;
            
            // Penalty
            let rate = parseFloat(document.getElementById("penyRate").value);
            let peny = (document.getElementById("chkPeny").checked && rate) ? s*(rate/100)*(days/365) : 0;

            let total = s + p3 + inf + peny;
            
            document.getElementById("outBody").innerText = s.toFixed(2);
            document.getElementById("out3").innerText = p3.toFixed(2);
            document.getElementById("outInf").innerText = inf.toFixed(2);
            document.getElementById("outPeny").innerText = peny.toFixed(2);
            document.getElementById("debtTotal").innerText = total.toFixed(2) + " –≥—Ä–Ω";
            document.getElementById("resDebt").style.display = "block";
            
            sendBtn({
                type:"debt_calc", 
                total:total.toFixed(2), 
                details: `3%: ${p3.toFixed(2)}\n–Ü–Ω—Ñ–ª: ${inf.toFixed(2)}\n–ü–µ–Ω—è: ${peny.toFixed(2)}`
            });
        }

        // --- 3. VACATION (PRO) ---
        // –§—É–Ω–∫—Ü—ñ—è –ü–∞—Å—Ö–∞–ª—ñ—ó (–ì–∞—É—Å—Å)
        function getEasterDate(year) {
            let a = year % 19, b = year % 4, c = year % 7;
            let d = (19 * a + 15) % 30;
            let e = (2 * b + 4 * c + 6 * d + 6) % 7;
            let f = d + e;
            let day = (f + 4 > 30) ? (f + 4 - 30) : (f + 4);
            let month = (f + 4 > 30) ? 4 : 3; // JS Month: 0-11 (4 = —Ç—Ä–∞–≤–µ–Ω—å, 3 = –∫–≤—ñ—Ç–µ–Ω—å)
            return new Date(year, month, day);
        }

        function getHolidays(year) {
            // –§—ñ–∫—Å–æ–≤–∞–Ω—ñ (—Å—É—á–∞—Å–Ω–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä)
            let h = [
                `${year}-01-01`, // –ù–æ–≤–∏–π —Ä—ñ–∫
                `${year}-03-08`, // 8 –±–µ—Ä–µ–∑–Ω—è
                `${year}-05-01`, // –î–µ–Ω—å –ø—Ä–∞—Ü—ñ
                `${year}-05-08`, // –î–µ–Ω—å –ø–∞–º'—è—Ç—ñ
                `${year}-06-28`, // –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü—ñ—è
                `${year}-07-15`, // –î–µ—Ä–∂–∞–≤–Ω—ñ—Å—Ç—å
                `${year}-08-24`, // –ù–µ–∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å
                `${year}-10-01`, // –ó–∞—Ö–∏—Å–Ω–∏–∫—ñ–≤
                `${year}-12-25`  // –†—ñ–∑–¥–≤–æ
            ];
            
            // –†—É—Ö–æ–º—ñ
            let easter = getEasterDate(year);
            // –§–æ—Ä–º–∞—Ç—É—î–º–æ –¥–∞—Ç—É YYYY-MM-DD
            const fmt = d => d.toISOString().split('T')[0];
            h.push(fmt(easter));
            
            let trinity = new Date(easter);
            trinity.setDate(easter.getDate() + 49);
            h.push(fmt(trinity));
            
            return h;
        }

        function calcVac() {
            let startVal = document.getElementById("vacStart").value;
            let days = parseInt(document.getElementById("vacDays").value);
            let isMartial = document.getElementById("martialLaw").checked;
            
            if(!startVal || !days) return;

            let current = new Date(startVal);
            let added = 0;
            let holidaySet = new Set();
            
            // –Ø–∫—â–æ –Ω–µ –≤–æ—î–Ω–Ω–∏–π —Å—Ç–∞–Ω, –≥–µ–Ω–µ—Ä—É—î–º–æ —Å–≤—è—Ç–∞
            if(!isMartial) {
                // –ë–µ—Ä–µ–º–æ —Å–≤—è—Ç–∞ –Ω–∞ –ø–æ—Ç–æ—á–Ω–∏–π —Ä—ñ–∫ —ñ –Ω–∞—Å—Ç—É–ø–Ω–∏–π (—è–∫—â–æ –≤—ñ–¥–ø—É—Å—Ç–∫–∞ –Ω–∞ –ø–µ—Ä–µ—Ç–∏–Ω—ñ —Ä–æ–∫—ñ–≤)
                let y1 = current.getFullYear();
                let y2 = y1 + 1;
                getHolidays(y1).forEach(d => holidaySet.add(d));
                getHolidays(y2).forEach(d => holidaySet.add(d));
            }

            // –õ–æ–≥—ñ–∫–∞: –°–≤—è—Ç–∫–æ–≤—ñ –¥–Ω—ñ –Ω–µ –≤—Ö–æ–¥—è—Ç—å —É —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –≤—ñ–¥–ø—É—Å—Ç–∫–∏
            while(added < days) {
                let dateStr = current.toISOString().split('T')[0];
                
                // –Ø–∫—â–æ –Ω–µ –≤–æ—î–Ω–Ω–∏–π —Å—Ç–∞–Ω –Ü —Å—å–æ–≥–æ–¥–Ω—ñ —Å–≤—è—Ç–æ -> –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ (–Ω–µ –¥–æ–¥–∞—î–º–æ added, –∞–ª–µ –¥–µ–Ω—å –º–∏–Ω–∞—î)
                if(!isMartial && holidaySet.has(dateStr)) {
                    // –¶–µ —Å–≤—è—Ç–æ. –í–æ–Ω–æ –ø—Ä–æ–¥–æ–≤–∂—É—î –≤—ñ–¥–ø—É—Å—Ç–∫—É.
                } else {
                    added++;
                }
                
                // –Ø–∫—â–æ —Ü–µ —â–µ –Ω–µ –æ—Å—Ç–∞–Ω–Ω—ñ–π –≤—Ä–∞—Ö–æ–≤–∞–Ω–∏–π –¥–µ–Ω—å, —Ä—É—Ö–∞—î–º–æ—Å—å –¥–∞–ª—ñ
                if(added < days) {
                    current.setDate(current.getDate() + 1);
                }
            }
            // current —Ç–µ–ø–µ—Ä —Ü–µ –û—Å—Ç–∞–Ω–Ω—ñ–π –¥–µ–Ω—å –≤—ñ–¥–ø—É—Å—Ç–∫–∏
            document.getElementById("vacLast").innerText = current.toLocaleDateString('uk-UA');

            // –®—É–∫–∞—î–º–æ –¥–µ–Ω—å –≤–∏—Ö–æ–¥—É (–Ω–∞—Å—Ç—É–ø–Ω–∏–π –¥–µ–Ω—å)
            let returnDate = new Date(current);
            returnDate.setDate(returnDate.getDate() + 1);
            
            // –Ø–∫—â–æ –≤–∏–ø–∞–¥–∞—î –Ω–∞ –≤–∏—Ö—ñ–¥–Ω–∏–π -> –ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ –Ω–∞ –ü–Ω
            while(returnDate.getDay() === 0 || returnDate.getDay() === 6) {
                returnDate.setDate(returnDate.getDate() + 1);
            }
            document.getElementById("vacReturn").innerText = returnDate.toLocaleDateString('uk-UA');
        }

        // --- 4. CURRENCY (API) ---
        let ratesCache = {};
        async function fetchRates() {
            let dateVal = document.getElementById("currDate").value;
            let dateStr = dateVal.replaceAll('-', '');
            let url = `https://bank.gov.ua/NBUStatService/v1/statdirectory/exchange?date=${dateStr}&json`;
            
            document.getElementById("loading").style.display = "block";
            document.getElementById("ratesList").innerHTML = "";

            try {
                let resp = await fetch(url);
                let data = await resp.json();
                document.getElementById("loading").style.display = "none";
                
                let usd = data.find(r => r.cc === "USD");
                let eur = data.find(r => r.cc === "EUR");
                ratesCache = { USD: usd?.rate, EUR: eur?.rate };

                let html = "";
                if(usd) html += `<div class="currency-card"><div><span class="flag">üá∫üá∏</span>USD</div><div class="rate-val">${usd.rate.toFixed(4)}</div></div>`;
                if(eur) html += `<div class="currency-card"><div><span class="flag">üá™üá∫</span>EUR</div><div class="rate-val">${eur.rate.toFixed(4)}</div></div>`;
                
                document.getElementById("ratesList").innerHTML = html;
                convert();
            } catch(e) {
                document.getElementById("ratesList").innerHTML = `<div style="color:red">–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ –ù–ë–£</div>`;
                document.getElementById("loading").style.display = "none";
            }
        }

        function convert() {
            let amt = parseFloat(document.getElementById("convAmount").value);
            let curr = document.getElementById("convCurr").value;
            if(amt && ratesCache[curr]) {
                document.getElementById("convResult").innerText = (amt * ratesCache[curr]).toFixed(2) + " UAH";
            }
        }

        // --- 5. DATES ---
        function calcDateSimple() {
            let d = new Date(document.getElementById("dateCalc1").value);
            let add = parseInt(document.getElementById("dateCalcDays").value);
            if(!isNaN(d.getTime()) && add) {
                d.setDate(d.getDate() + add);
                document.getElementById("dateSimpleRes").innerText = d.toLocaleDateString('uk-UA');
                document.getElementById("resDateSimple").style.display = "block";
            }
        }

        // --- GLOBAL HELPER: SEND BUTTON ---
        function sendBtn(data) {
            mainButton.setText("–í–Ü–î–ü–†–ê–í–ò–¢–ò –í –ß–ê–¢");
            mainButton.isVisible = true; // Fix visibility logic
            mainButton.show();
            mainButton.offClick(sendDataCb);
            mainButton.onClick(sendDataCb);
            
            // Closure wrapper
            function sendDataCb() {
                tg.sendData(JSON.stringify(data));
            }
        }

        // --- DEFAULTS ---
        let today = new Date().toISOString().split('T')[0];
        document.getElementById('currDate').value = today;
        document.getElementById('dStart').value = today;
        document.getElementById('dEnd').value = today;
        document.getElementById('vacStart').value = today;
        document.getElementById('dateCalc1').value = today;

    </script>
</body>
</html>
