<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Legal Tool Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #222222);
            --hint-color: var(--tg-theme-hint-color, #888);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
            --accent: var(--tg-theme-button-color, #2481cc);
            --green: #34c759; /* iOS Green */
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0; display: flex; flex-direction: column; height: 100vh;
        }

        /* --- SCROLLABLE TABS --- */
        .tabs {
            display: flex; overflow-x: auto; white-space: nowrap;
            background-color: var(--secondary-bg);
            border-bottom: 1px solid #e0e0e0;
            scrollbar-width: none;
            padding-bottom: 2px;
        }
        .tabs::-webkit-scrollbar { display: none; }
        
        .tab {
            padding: 12px 15px; text-align: center;
            font-size: 14px; font-weight: 500; color: var(--hint-color);
            border-bottom: 3px solid transparent; flex-shrink: 0;
            transition: color 0.2s;
        }
        .tab.active { color: var(--accent); border-bottom: 3px solid var(--accent); }

        /* --- CONTENT --- */
        .content { padding: 15px; flex: 1; overflow-y: auto; display: none; }
        .content.active { display: block; }

        /* --- UI ELEMENTS --- */
        h2 { margin: 0 0 10px 0; font-size: 18px; }
        label { font-size: 13px; color: var(--hint-color); margin-bottom: 4px; display: block; }
        
        select, input[type="text"], input[type="number"], input[type="date"] {
            width: 100%; padding: 12px; border-radius: 10px;
            border: 1px solid var(--hint-color);
            background-color: var(--secondary-bg);
            color: var(--text-color);
            font-size: 16px; outline: none; margin-bottom: 15px;
            box-sizing: border-box; -webkit-appearance: none;
        }

        .row { display: flex; gap: 10px; }
        .col { flex: 1; }

        .result-box {
            background-color: var(--secondary-bg);
            padding: 15px; border-radius: 12px;
            margin-top: 10px; text-align: center; display: none;
        }
        .price { font-size: 26px; font-weight: bold; color: var(--accent); }
        .detail-row {
            display: flex; justify-content: space-between;
            font-size: 14px; margin-top: 5px; border-bottom: 1px dashed var(--hint-color);
            padding-bottom: 4px;
        }

        /* --- TOGGLE SWITCH (iOS Style) --- */
        .setting-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; background: var(--secondary-bg);
            padding: 10px 15px; border-radius: 12px;
        }
        .setting-label { font-size: 16px; font-weight: 500; }

        .switch {
            position: relative; display: inline-block; width: 50px; height: 30px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        
        .slider {
            position: absolute; cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: "";
            height: 26px; width: 26px;
            left: 2px; bottom: 2px;
            background-color: white; transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input:checked + .slider { background-color: var(--green); }
        input:focus + .slider { box-shadow: 0 0 1px var(--green); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Currency Card */
        .currency-card {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; background: var(--secondary-bg);
            border-radius: 12px; margin-bottom: 8px; font-weight: 500;
        }
        .rate-val { font-weight: bold; color: var(--accent); font-size: 16px;}

    </style>
</head>
<body>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('court')">üèõ –ó–±—ñ—Ä</div>
        <div class="tab" onclick="switchTab('debt')">üìâ –ë–æ—Ä–≥–∏</div>
        <div class="tab" onclick="switchTab('curr')">üí≤ –í–∞–ª—é—Ç–∞</div>
        <div class="tab" onclick="switchTab('vacation')">üèñ –í—ñ–¥–ø—É—Å—Ç–∫–∞</div>
        <div class="tab" onclick="switchTab('dates')">üìÖ –°—Ç—Ä–æ–∫–∏</div>
    </div>

    <div id="tab-court" class="content active">
        <label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è (–ü–ú 2026: 3328 –≥—Ä–Ω)</label>
        <select id="claimType" onchange="calcCourt()">
            <option value="money">üí∞ –ú–∞–π–Ω–æ–≤–∏–π (–°—Ç—è–≥–Ω–µ–Ω–Ω—è)</option>
            <option value="divorce">üíî –†–æ–∑—ñ—Ä–≤–∞–Ω–Ω—è —à–ª—é–±—É</option>
            <option value="division">üè† –ü–æ–¥—ñ–ª –º–∞–π–Ω–∞</option>
            <option value="non_money">üìÑ –Ü–Ω—à–∏–π –Ω–µ–º–∞–π–Ω–æ–≤–∏–π</option>
            <option value="moral">‚öñÔ∏è –ú–æ—Ä–∞–ª—å–Ω–∞ —à–∫–æ–¥–∞</option>
        </select>
        <div id="courtPriceBlock">
            <label>–¶—ñ–Ω–∞ –ø–æ–∑–æ–≤—É (–≥—Ä–Ω)</label>
            <input type="number" id="courtPrice" placeholder="–°—É–º–∞..." oninput="calcCourt()">
        </div>
        <div class="result-box" id="resCourt">
            <div class="price" id="courtTotal">0 –≥—Ä–Ω</div>
            <div style="font-size:12px" id="courtDesc"></div>
        </div>
    </div>

    <div id="tab-debt" class="content">
        <label>–°—É–º–∞ –±–æ—Ä–≥—É</label>
        <input type="number" id="debtSum" placeholder="10000" oninput="calcDebt()">
        <div class="row">
            <div class="col"><label>–ü–æ—á–∞—Ç–æ–∫</label><input type="date" id="dStart" onchange="calcDebt()"></div>
            <div class="col"><label>–ö—ñ–Ω–µ—Ü—å</label><input type="date" id="dEnd" onchange="calcDebt()"></div>
        </div>

        <div class="setting-row">
            <span class="setting-label">3% —Ä—ñ—á–Ω–∏—Ö</span>
            <label class="switch">
                <input type="checkbox" id="chk3" checked onchange="calcDebt()">
                <span class="slider"></span>
            </label>
        </div>

        <div class="setting-row">
            <span class="setting-label">–Ü–Ω—Ñ–ª—è—Ü—ñ–π–Ω—ñ</span>
            <label class="switch">
                <input type="checkbox" id="chkInf" onchange="calcDebt()">
                <span class="slider"></span>
            </label>
        </div>
        <input type="number" id="infIdx" placeholder="–Ü–Ω–¥–µ–∫—Å (–Ω–∞–ø—Ä. 105.5)" value="100" style="display:none" oninput="calcDebt()">

        <div class="setting-row">
            <span class="setting-label">–ü–µ–Ω—è</span>
            <label class="switch">
                <input type="checkbox" id="chkPeny" onchange="toggleInput('penyInput', this)">
                <span class="slider"></span>
            </label>
        </div>
        <div id="penyInput" style="display:none">
            <label>–°—Ç–∞–≤–∫–∞ –ø–µ–Ω—ñ (%)</label>
            <input type="number" id="penyRate" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥ 25" value="0" oninput="calcDebt()">
        </div>

        <div class="result-box" id="resDebt" style="text-align: left;">
            <div class="detail-row"><span>–¢—ñ–ª–æ:</span> <span id="outBody">0</span></div>
            <div class="detail-row"><span>3%:</span> <span id="out3">0</span></div>
            <div class="detail-row"><span>–Ü–Ω—Ñ–ª:</span> <span id="outInf">0</span></div>
            <div class="detail-row"><span>–ü–µ–Ω—è:</span> <span id="outPeny">0</span></div>
            <div style="text-align:center; margin-top:10px">–†–ê–ó–û–ú: <span class="price" id="debtTotal">0</span></div>
        </div>
    </div>

    <div id="tab-curr" class="content">
        <label>–î–∞—Ç–∞ –∫—É—Ä—Å—É (–ù–ë–£)</label>
        <input type="date" id="currDate" onchange="fetchRates()">
        <div id="loading" style="text-align:center; display:none; margin: 10px 0;">‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
        <div id="ratesList"></div>

        <label style="margin-top:20px">–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä</label>
        <div class="row">
            <input type="number" id="convAmount" placeholder="100" oninput="convert()">
            <select id="convCurr" onchange="convert()">
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
            </select>
        </div>
        <div class="result-box" id="resConv" style="display:block">
            <div class="price" id="convResult">0 UAH</div>
        </div>
    </div>

    <div id="tab-vacation" class="content">
        <label>–ü–æ—á–∞—Ç–æ–∫ –≤—ñ–¥–ø—É—Å—Ç–∫–∏</label>
        <input type="date" id="vacStart" onchange="calcVac()">
        <label>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥–Ω—ñ–≤</label>
        <input type="number" id="vacDays" value="14" oninput="calcVac()">

        <div class="setting-row">
            <span class="setting-label">–í–æ—î–Ω–Ω–∏–π —Å—Ç–∞–Ω</span>
            <label class="switch">
                <input type="checkbox" id="martialLaw" checked onchange="calcVac()">
                <span class="slider"></span>
            </label>
        </div>
        <div style="font-size:12px; color:#888; padding:0 5px;">*–Ø–∫—â–æ —É–≤—ñ–º–∫–Ω–µ–Ω–æ, —Å–≤—è—Ç–∫–æ–≤—ñ –¥–Ω—ñ –≤–≤–∞–∂–∞—é—Ç—å—Å—è —Ä–æ–±–æ—á–∏–º–∏.</div>

        <div class="result-box" id="resVac" style="display:block; text-align:left">
            <div class="detail-row"><span>–û—Å—Ç–∞–Ω–Ω—ñ–π –¥–µ–Ω—å:</span> <span id="vacLast" style="font-weight:bold">-</span></div>
            <div class="detail-row"><span>–ù–∞ —Ä–æ–±–æ—Ç—É:</span> <span id="vacReturn" style="font-weight:bold; color:var(--accent)">-</span></div>
        </div>
    </div>

    <div id="tab-dates" class="content">
        <label>üìÜ –î–æ–¥–∞—Ç–∏ –¥–Ω—ñ –¥–æ –¥–∞—Ç–∏</label>
        <div class="row">
            <div class="col"><label>–î–∞—Ç–∞</label><input type="date" id="dateCalc1"></div>
            <div class="col"><label>+ –î–Ω—ñ–≤</label><input type="number" id="dateCalcDays" placeholder="10"></div>
        </div>
        <button onclick="calcDateSimple()" style="width:100%; padding:14px; background:var(--accent); color:#fff; border:none; border-radius:12px; font-size:16px; font-weight:bold;">–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –¥–∞—Ç—É</button>
        <div class="result-box" id="resDateSimple">
            <div class="price" id="dateSimpleRes">-</div>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();
        const mainButton = tg.MainButton;
        const PM = 3328; 

        // === TABS ===
        function switchTab(id) {
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            event.currentTarget.classList.add('active'); // Fixed selector
            if(id === 'curr') fetchRates();
        }

        // === 1. COURT ===
        function calcCourt() {
            let type = document.getElementById("claimType").value;
            let price = parseFloat(document.getElementById("courtPrice").value);
            let fee = 0;
            
            document.getElementById("courtPriceBlock").style.display = (type.includes("non_money") || type === "divorce") ? "none" : "block";

            if (type === "money" && price) fee = Math.max(PM*0.4, Math.min(price*0.01, PM*5));
            else if (type === "divorce" || type === "non_money") fee = PM*0.4;
            else if (type === "division" && price) fee = Math.max(PM*0.4, Math.min(price*0.01, PM*3));
            else if (type === "moral" && price) fee = (price <= PM*5) ? PM*0.4 : Math.max(PM, price*0.015);

            document.getElementById("courtTotal").innerText = fee.toFixed(2) + " –≥—Ä–Ω";
            document.getElementById("resCourt").style.display = "block";
            setupBtn({type:"court_fee", fee:fee.toFixed(2), desc:type});
        }

        // === 2. DEBT ===
        function toggleInput(id, cb) {
            document.getElementById(id).style.display = cb.checked ? "block" : "none";
            calcDebt();
        }

        function calcDebt() {
            let s = parseFloat(document.getElementById("debtSum").value);
            let d1 = new Date(document.getElementById("dStart").value);
            let d2 = new Date(document.getElementById("dEnd").value);
            
            document.getElementById("infIdx").style.display = document.getElementById("chkInf").checked ? "block" : "none";

            if(!s || isNaN(d1) || isNaN(d2)) return;
            let days = Math.max(0, (d2-d1)/(86400000));
            
            let p3 = document.getElementById("chk3").checked ? s * 0.03 * (days/365) : 0;
            let idx = parseFloat(document.getElementById("infIdx").value);
            let inf = (document.getElementById("chkInf").checked && idx > 100) ? s*(idx/100)-s : 0;
            
            let rate = parseFloat(document.getElementById("penyRate").value);
            let peny = (document.getElementById("chkPeny").checked && rate) ? s*(rate/100)*(days/365) : 0;

            let total = s + p3 + inf + peny;
            
            document.getElementById("outBody").innerText = s.toFixed(2);
            document.getElementById("out3").innerText = p3.toFixed(2);
            document.getElementById("outInf").innerText = inf.toFixed(2);
            document.getElementById("outPeny").innerText = peny.toFixed(2);
            document.getElementById("debtTotal").innerText = total.toFixed(2) + " –≥—Ä–Ω";
            document.getElementById("resDebt").style.display = "block";
            
            setupBtn({type:"debt_calc", total:total.toFixed(2), details: `3%: ${p3.toFixed(2)}, Inf: ${inf.toFixed(2)}`});
        }

        // === 3. CURRENCY ===
        let ratesCache = {};
        async function fetchRates() {
            let dateVal = document.getElementById("currDate").value;
            let dateStr = dateVal.replaceAll('-', '');
            let url = `https://bank.gov.ua/NBUStatService/v1/statdirectory/exchange?date=${dateStr}&json`;
            
            document.getElementById("loading").style.display = "block";
            document.getElementById("ratesList").innerHTML = "";

            try {
                let resp = await fetch(url);
                let data = await resp.json();
                document.getElementById("loading").style.display = "none";
                
                let usd = data.find(r => r.cc === "USD");
                let eur = data.find(r => r.cc === "EUR");
                ratesCache = { USD: usd?.rate, EUR: eur?.rate };

                let html = "";
                if(usd) html += `<div class="currency-card"><div>üá∫üá∏ USD</div><div class="rate-val">${usd.rate.toFixed(4)}</div></div>`;
                if(eur) html += `<div class="currency-card"><div>üá™üá∫ EUR</div><div class="rate-val">${eur.rate.toFixed(4)}</div></div>`;
                document.getElementById("ratesList").innerHTML = html;
                convert();
            } catch(e) {
                document.getElementById("ratesList").innerHTML = "–ü–æ–º–∏–ª–∫–∞ –ù–ë–£";
            }
        }
        function convert() {
            let amt = parseFloat(document.getElementById("convAmount").value);
            let curr = document.getElementById("convCurr").value;
            if(amt && ratesCache[curr]) {
                document.getElementById("convResult").innerText = (amt * ratesCache[curr]).toFixed(2) + " UAH";
            }
        }

        // === 4. VACATION ===
        const holidays = ["01-01", "01-07", "03-08", "05-01", "05-09", "06-28", "08-24", "12-25"]; 
        function calcVac() {
            let start = new Date(document.getElementById("vacStart").value);
            let days = parseInt(document.getElementById("vacDays").value);
            let isMartial = document.getElementById("martialLaw").checked;
            
            if(isNaN(start) || !days) return;
            let current = new Date(start);
            let added = 0;
            
            // –Ø–∫—â–æ –¥–µ–Ω—å —Å—Ç–∞—Ä—Ç—É - —Ü–µ –≤–∂–µ –¥–µ–Ω—å –≤—ñ–¥–ø—É—Å—Ç–∫–∏, —Ç–æ –ø–µ—Ä—à–∏–π –¥–µ–Ω—å –≤–∂–µ –≤—Ä–∞—Ö–æ–≤–∞–Ω–æ? 
            // –ó–∞–∑–≤–∏—á–∞–π —Ä–∞—Ö—É—é—Ç—å –∑ –ø–µ—Ä—à–æ–≥–æ –¥–Ω—è.
            // current.setDate(current.getDate() - 1); // fix logic loop

            while(added < days) {
                // –î–∏–≤–∏–º–æ—Å—å –Ω–∞ –ø–æ—Ç–æ—á–Ω–∏–π –¥–µ–Ω—å
                if (!isMartial) {
                    let md = ("0" + (current.getMonth()+1)).slice(-2) + "-" + ("0" + current.getDate()).slice(-2);
                    if (holidays.includes(md)) {
                        current.setDate(current.getDate() + 1); // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ —Å–≤—è—Ç–æ (–≤–æ–Ω–æ –Ω–µ –π–¥–µ –≤ –∑–∞–ª—ñ–∫ –¥–Ω—ñ–≤)
                        continue; 
                    }
                }
                added++;
                if(added < days) current.setDate(current.getDate() + 1); // –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ, —è–∫—â–æ —â–µ –Ω–µ –∫—ñ–Ω–µ—Ü—å
            }
            
            document.getElementById("vacLast").innerText = current.toLocaleDateString();
            
            let returnDate = new Date(current);
            returnDate.setDate(returnDate.getDate() + 1);
            while(returnDate.getDay() === 0 || returnDate.getDay() === 6) {
                returnDate.setDate(returnDate.getDate() + 1);
            }
            document.getElementById("vacReturn").innerText = returnDate.toLocaleDateString();
        }

        // === 5. DATE SIMPLE ===
        function calcDateSimple() {
            let d = new Date(document.getElementById("dateCalc1").value);
            let add = parseInt(document.getElementById("dateCalcDays").value);
            if(!isNaN(d) && add) {
                d.setDate(d.getDate() + add);
                document.getElementById("dateSimpleRes").innerText = d.toLocaleDateString();
                document.getElementById("resDateSimple").style.display = "block";
            }
        }

        function setupBtn(data) {
            mainButton.setText("–í–Ü–î–ü–†–ê–í–ò–¢–ò");
            mainButton.show();
            mainButton.offClick(sendData);
            mainButton.onClick(sendData);
            function sendData() { tg.sendData(JSON.stringify(data)); }
        }

        // Defaults
        let today = new Date().toISOString().split('T')[0];
        document.getElementById('currDate').value = today;
        document.getElementById('dStart').value = today;
        document.getElementById('dEnd').value = today;
        document.getElementById('vacStart').value = today;
        document.getElementById('dateCalc1').value = today;

    </script>
</body>
</html>
