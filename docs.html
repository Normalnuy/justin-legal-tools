<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AI Legal Docs</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-secondary-bg-color, #f2f2f7);
            --card-bg: var(--tg-theme-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #000000);
            --accent-color: var(--tg-theme-button-color, #007aff);
            --pro-gradient: linear-gradient(135deg, #ff9f0a, #ffd60a);
        }
        body { margin: 0; padding: 0; font-family: sans-serif; background: var(--bg-color); color: var(--text-color); padding-bottom: 80px; }
        
        /* Loader */
        #loader {
            position: fixed; top:0; left:0; right:0; bottom:0;
            background: var(--bg-color); z-index: 999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #ccc; border-top-color: var(--accent-color);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Header */
        .header { padding: 16px; background: var(--card-bg); position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .title-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; color: white; }
        .badge.lite { background: #8e8e93; }
        .badge.pro { background: var(--pro-gradient); }
        
        .search-input { width: 100%; padding: 12px; border-radius: 10px; border: none; background: #efeff4; box-sizing: border-box; font-size: 16px; }

        /* List */
        .container { padding: 16px; }
        .cat-title { font-size: 14px; font-weight: bold; color: #8e8e93; margin: 16px 0 8px 10px; text-transform: uppercase; }
        .doc-card {
            background: var(--card-bg); padding: 16px; border-radius: 12px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        }
        .doc-card:active { opacity: 0.7; }
        .pro-tag { border: 1px solid orange; color: orange; font-size: 10px; padding: 2px 4px; border-radius: 4px; margin-left: 5px; font-weight: bold; }
        .locked { opacity: 0.6; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; w: 100%; h: 100%; background: rgba(0,0,0,0.5); z-index: 200; justify-content: center; align-items: flex-end; }
        .modal.active { display: flex; }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 600px; padding: 20px; border-radius: 20px 20px 0 0; max-height: 90vh; overflow-y: auto; }
        
        .form-input { width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; background: var(--bg-color); }
        .form-label { font-size: 12px; margin-bottom: 4px; display: block; color: #8e8e93; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; color: white; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; }
        .btn-primary { background: var(--accent-color); }
        .btn-pro { background: var(--pro-gradient); }
    </style>
</head>
<body>

    <!-- Loader -->
    <div id="loader">
        <div class="spinner"></div>
        <div style="color: #8e8e93; font-size: 14px;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —à–∞–±–ª–æ–Ω—ñ–≤...</div>
    </div>

    <!-- UI -->
    <div id="app" style="display: none;">
        <div class="header">
            <div class="title-row">
                <span style="font-size: 20px; font-weight: 700;">–Æ—Ä–∏–¥–∏—á–Ω—ñ –î–æ–∫—É–º–µ–Ω—Ç–∏</span>
                <span id="userBadge" class="badge lite">Lite</span>
            </div>
            <input type="text" id="search" class="search-input" placeholder="–ü–æ—à—É–∫..." oninput="app.render()">
        </div>

        <div id="list" class="container"></div>
    </div>

    <!-- Form Modal -->
    <div id="formModal" class="modal">
        <div class="modal-content">
            <h3 id="formTitle">...</h3>
            <div id="formFields"></div>
            <button class="btn btn-primary" onclick="app.submit()">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
            <button class="btn" style="background:transparent; color: #8e8e93; margin-top: 5px;" onclick="app.closeModals()">–ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
    </div>

    <!-- Pro Modal -->
    <div id="proModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <div style="font-size: 50px;">üîí</div>
            <h3>–¢—ñ–ª—å–∫–∏ –¥–ª—è PRO</h3>
            <p style="color: #8e8e93;">–¶–µ–π –¥–æ–∫—É–º–µ–Ω—Ç –¥–æ—Å—Ç—É–ø–Ω–∏–π —É –ø–ª–∞—Ç–Ω—ñ–π –ø—ñ–¥–ø–∏—Å—Ü—ñ.</p>
            <button class="btn btn-pro" onclick="app.buyPro()">–ö—É–ø–∏—Ç–∏ PRO</button>
            <button class="btn" style="background:transparent; color: #8e8e93; margin-top: 5px;" onclick="app.closeModals()">–ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // ‚ö†Ô∏è –í–°–¢–ê–í–¢–ï –°–Æ–î–ò –°–í–û–Ñ –ü–û–°–ò–õ–ê–ù–ù–Ø –ù–ê RAW JSON –ó GITHUB
        const CONFIG_URL = "https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/templates.json";

        const urlParams = new URLSearchParams(window.location.search);
        const IS_PRO = urlParams.get('plan') === 'pro';

        const app = {
            config: null,
            currentId: null,

            async init() {
                try {
                    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
                    const response = await fetch(CONFIG_URL);
                    if (!response.ok) throw new Error("Network response was not ok");
                    this.config = await response.json();
                    
                    // UI Init
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('app').style.display = 'block';
                    
                    const badge = document.getElementById('userBadge');
                    if(IS_PRO) { badge.innerText = "PRO"; badge.className = "badge pro"; }
                    
                    this.render();
                } catch (e) {
                    document.getElementById('loader').innerHTML = `<div style="color:red">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:<br>${e.message}</div>`;
                }
            },

            render() {
                const search = document.getElementById('search').value.toLowerCase();
                const container = document.getElementById('list');
                container.innerHTML = '';
                
                const templates = this.config.templates;
                const categories = this.config.categories;

                // –ì—Ä—É–ø—É–≤–∞–Ω–Ω—è
                const grouped = {};
                templates.forEach(t => {
                    if(search && !t.title.toLowerCase().includes(search)) return;
                    if(!grouped[t.cat]) grouped[t.cat] = [];
                    grouped[t.cat].push(t);
                });

                for (const [catKey, items] of Object.entries(grouped)) {
                    if (items.length === 0) continue;
                    
                    const title = document.createElement('div');
                    title.className = 'cat-title';
                    title.innerText = categories[catKey] || catKey;
                    container.appendChild(title);

                    items.forEach(item => {
                        const div = document.createElement('div');
                        const isLocked = item.pro && !IS_PRO;
                        div.className = `doc-card ${isLocked ? 'locked' : ''}`;
                        div.onclick = () => this.clickItem(item, isLocked);
                        
                        const proHTML = item.pro ? `<span class="pro-tag">PRO</span>` : '';
                        const lockIcon = isLocked ? 'üîí' : 'üìÑ';
                        
                        div.innerHTML = `
                            <div>${item.title} ${proHTML}</div>
                            <div style="font-size: 20px;">${lockIcon}</div>
                        `;
                        container.appendChild(div);
                    });
                }
            },

            clickItem(item, isLocked) {
                tg.HapticFeedback.impactOccurred(isLocked ? 'error' : 'light');
                if (isLocked) {
                    document.getElementById('proModal').classList.add('active');
                } else {
                    this.openForm(item);
                }
            },

            openForm(item) {
                this.currentId = item.id;
                document.getElementById('formTitle').innerText = item.title;
                const container = document.getElementById('formFields');
                container.innerHTML = '';

                // –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ–ª—è –∑ –ø—Ä–µ—Å–µ—Ç—É
                const fields = this.config.presets[item.preset] || this.config.presets['general'];

                fields.forEach(f => {
                    const lbl = document.createElement('label');
                    lbl.className = 'form-label';
                    lbl.innerText = f.l;
                    container.appendChild(lbl);

                    let inp;
                    if (f.t === 'area') {
                        inp = document.createElement('textarea');
                    } else if (f.t === 'date') {
                        inp = document.createElement('input');
                        inp.type = 'date';
                    } else {
                        inp = document.createElement('input');
                        inp.type = 'text';
                    }
                    inp.className = 'form-input';
                    inp.id = `in_${f.k}`;
                    inp.placeholder = f.p || '';
                    container.appendChild(inp);
                });

                document.getElementById('formModal').classList.add('active');
            },

            closeModals() {
                document.querySelectorAll('.modal').forEach(el => el.classList.remove('active'));
            },

            submit() {
                const inputs = {};
                document.querySelectorAll('#formFields .form-input').forEach(el => {
                    inputs[el.id.replace('in_', '')] = el.value;
                });

                tg.HapticFeedback.notificationOccurred('success');
                tg.sendData(JSON.stringify({
                    action: "generate_legal",
                    template_id: this.currentId,
                    inputs: inputs
                }));
            },

            buyPro() {
                tg.sendData(JSON.stringify({action: "buy_pro"}));
                this.closeModals();
            }
        };

        app.init();
    </script>
</body>
</html>
